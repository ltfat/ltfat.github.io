 
<!DOCTYPE html>
<html lang="en">
<head class="include" file="../../include/header.html">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta NAME="keywords" CONTENT="gabor, wavelets, filterbank, signal processing, matlab,
octave"/>
<title>FILTERBANKCONSTPHASE - Construct phase from FILTERBANK or UFILTERBANK magnitude</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.6.5/css/bootstrap-select.min.css">
<link rel="stylesheet" href="../../include/style.css" type="text/css">
<link rel="stylesheet" href="../../include/highlight.css" type="text/css">
</head>

<!-- body must stay hidden until all include parts are loaded -->
<body style="display:none;">
<!-- Wrap the content into responsive container --!>
<div class="container">
<!-- Include main navigation -->
<div class="masthead include" file="../../include/mainnav.html">
</div>
<div class="row">
    <div class="col-md-2" id="codeswitch"><div id="menutitle"><a href="filterbankconstphase.html">View the help</a></div>
</div>
    <div class="col-md-offset-5 col-md-5" id="jumplist">This is where navigation should be.</div>
</div>
<div class="row">
    <div class="col-md-2">
        <div class="include" file='../include/docnav.html'></div>
        <div id="seealso"><p><div id="menutitle">See also:</div>
<ul>
<li><a href="#BASEURL#/doc/base/ltfatmex.html">ltfatmex</a></li>
<li><a href="#BASEURL#/doc/filterbank/filterbank.html">filterbank</a></li>
<li><a href="#BASEURL#/doc/filterbank/ufilterbank.html">ufilterbank</a></li>
<li><a href="#BASEURL#/doc/filterbank/audfilters.html">audfilters</a></li>
<li><a href="#BASEURL#/doc/filterbank/cqtfilters.html">cqtfilters</a></li>
<li><a href="#BASEURL#/doc/filterbank/gabfilters.html">gabfilters</a></li>
</ul>
</p></div>
    </div>
    <div class="col-md-10">

        <h1 class="title">FILTERBANKCONSTPHASE - Construct phase from FILTERBANK or UFILTERBANK magnitude</h1>
<h2>Program code:</h2>
<div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>[c,newphase,usedmask,tgrad,fgrad]<span class="p">=</span><span class="nf">filterbankconstphase</span><span class="p">(</span>s,a,fc,tfr,varargin<span class="p">)</span><span class="w"></span>
<span class="c">%FILTERBANKCONSTPHASE Construct phase from FILTERBANK or UFILTERBANK magnitude </span><span class="w"></span>
<span class="c">%   Usage:  c=filterbankconstphase(s,a,fc,tfr);</span><span class="w"></span>
<span class="c">%           c=filterbankconstphase(c,a,fc,tfr,mask);</span><span class="w"></span>
<span class="c">%           c=filterbankconstphase(s,a,fc,tfr,mask,usephase);</span><span class="w"></span>
<span class="c">%           c=filterbankconstphase(s,a,fc,{tgrad,fgrad},...);</span><span class="w"></span>
<span class="c">%           [c,newphase,usedmask,tgrad,fgrad] = filterbankconstphase(...);</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   Input parameters:</span><span class="w"></span>
<span class="c">%         s        : Initial coefficients.</span><span class="w"></span>
<span class="c">%         a        : Downsampling factor(s).</span><span class="w"></span>
<span class="c">%         fc       : Center frequencies (normalized to the Nyquist rate)</span><span class="w"></span>
<span class="c">%         tfr      : ERB of the filters (normalized to the Nyquist rate)</span><span class="w"></span>
<span class="c">%         mask     : Mask for selecting known phase.</span><span class="w"></span>
<span class="c">%         usephase : Explicit known phase.</span><span class="w"></span>
<span class="c">%   Output parameters:</span><span class="w"></span>
<span class="c">%         c        : Coefficients with the constructed phase.</span><span class="w"></span>
<span class="c">%         newphase : Just the (unwrapped) phase.</span><span class="w"></span>
<span class="c">%         usedmask : Mask for selecting coefficients with the new phase.</span><span class="w"></span>
<span class="c">%         tgrad    : Relative time phase derivative.</span><span class="w"></span>
<span class="c">%         fgrad    : Relative frequency phase derivative.</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   FILTERBANKCONSTPHASE(s,a,tfr,fc) will construct a suitable phase for </span><span class="w"></span>
<span class="c">%   the positive valued coefficients s. </span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   If s is the absolute value of filterbank coefficients comming from</span><span class="w"></span>
<span class="c">%   a filterbank with filters with center frequencies fc and time-frequency</span><span class="w"></span>
<span class="c">%   ratios tfr and subsampling factors a i.e.:</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%       [g,a,~,~,info] = ...filters(...);</span><span class="w"></span>
<span class="c">%       c = filterbank(f,g,a);</span><span class="w"></span>
<span class="c">%       s = abs(c);</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   then FILTERBANKCONSTPHASE(s,a,info.fc,info.tfr) will attempt to </span><span class="w"></span>
<span class="c">%   reconstruct c.</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   FILTERBANKCONSTPHASE(c,a,fc,tfr,mask) accepts real or complex valued</span><span class="w"></span>
<span class="c">%   c and real valued mask of the same size. Values in mask which can</span><span class="w"></span>
<span class="c">%   be converted to logical true (anything other than 0) determine</span><span class="w"></span>
<span class="c">%   coefficients with known phase which is used in the output. Only the</span><span class="w"></span>
<span class="c">%   phase of remaining coefficients (for which mask==0) is computed.</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   FILTERBANKCONSTPHASE(c,a,fc,tfr,mask,usephase) does the same as before</span><span class="w"></span>
<span class="c">%   but uses the known phase values from usephase rather than from c.</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   FILTERBANKCONSTPHASE(s,a,fc,{tgrad,fgrad},...) accepts the phase </span><span class="w"></span>
<span class="c">%   gradient {tgrad,fgrad} explicitly instead of computing it from</span><span class="w"></span>
<span class="c">%   the magnitude using tfr and the phase-magnitude relationship.</span><span class="w"></span>
<span class="c">%   This is directly compatible with FILTERBANKPHASEGRAD.</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   Addition parameters</span><span class="w"></span>
<span class="c">%   -------------------</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   The function accepts the following additional paramaters:</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   &#39;tol&#39;,tol </span><span class="w"></span>
<span class="c">%           The phase is computed only for coefficients above tol. The</span><span class="w"></span>
<span class="c">%           rest is set to random values.</span><span class="w"></span>
<span class="c">%           In addition, tol can be a vector containing decreasing values. </span><span class="w"></span>
<span class="c">%           In that case, the algorithm is run numel(tol) times, </span><span class="w"></span>
<span class="c">%           initialized with the result from the previous step in the 2nd </span><span class="w"></span>
<span class="c">%           and the further steps. </span><span class="w"></span>
<span class="c">%           The default value is tol=[1e-1, 1e-10].</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   &#39;real&#39; (default) or &#39;complex&#39;</span><span class="w"></span>
<span class="c">%           By default, the coefficients are expected to come from a real</span><span class="w"></span>
<span class="c">%           filterbank i.e. the filters cover only the positive</span><span class="w"></span>
<span class="c">%           frequencies. For filterbanks which cover the whole frequency</span><span class="w"></span>
<span class="c">%           range, pass &#39;complex&#39; instead.</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   &#39;naturalscaling&#39; (default) or &#39;peakscaling&#39; or &#39;custscaling&#39;,scal</span><span class="w"></span>
<span class="c">%           Relative scaling of the filter frequency responses. </span><span class="w"></span>
<span class="c">%           &#39;naturalscaling&#39; deduces the scaling of the filters from the</span><span class="w"></span>
<span class="c">%           subsampling factors a. </span><span class="w"></span>
<span class="c">%           &#39;peakscaling&#39; assumes all frequency responses were notmalized </span><span class="w"></span>
<span class="c">%           to have peaks of equal height.</span><span class="w"></span>
<span class="c">%           &#39;custscaling&#39;,scal allows passing a custom scaling vector scal. </span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   &#39;gabor&#39; (default) or &#39;wavelet&#39;</span><span class="w"></span>
<span class="c">%           Version of the phase-magnitude relationship to be used. In</span><span class="w"></span>
<span class="c">%           contrast to &#39;gabor&#39;, the &#39;wavelet&#39; option does not contain the</span><span class="w"></span>
<span class="c">%           term involving the derivative of sqrt(tfr). </span><span class="w"></span>
<span class="c">%           See the references for more details.</span><span class="w"></span>
<span class="c">%           </span><span class="w"></span>
<span class="c">%   This function requires a computational subroutine that is only</span><span class="w"></span>
<span class="c">%   available in C. Use LTFATMEX to compile it.</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   Example</span><span class="w"></span>
<span class="c">%   -------</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   We construct a constant-Q filterbank with fractional downsampling and a reasonably high redundancy.</span><span class="w"></span>
<span class="c">%   Then, we apply filterbankconstphase on the absolute values of the resulting coefficients to test the</span><span class="w"></span>
<span class="c">%   reconstruction accuracy of filterbankconstphase.</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%    [f,fs] = gspi;</span><span class="w"></span>
<span class="c">%    [g,a,fc,L,info]=cqtfilters(fs,100,fs/2 - 100,48,numel(f),&#39;fractional&#39;, &#39;redmul&#39;, 8, &#39;Qvar&#39;,4,&#39;subprec&#39;);</span><span class="w"></span>
<span class="c">%    corig = filterbank(f,g,a);</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%    c=filterbankconstphase(cellfun(@abs,corig,&#39;UniformOutput&#39;,0),a,info.fc,info.tfr,&#39;tol&#39;,1e-10);</span><span class="w"></span>
<span class="c">%    cproj = filterbank(ifilterbankiter(c,g,a,&#39;pcg&#39;,&#39;tol&#39;,1e-6),g,a);</span><span class="w"></span>
<span class="c">%    Cdb = 20*log10( norm(abs(cell2mat(corig)) - abs(cell2mat(cproj)) )/norm( abs(cell2mat(corig))) );</span><span class="w"></span>
<span class="c">%      </span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%       </span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   See also:  ltfatmex filterbank ufilterbank audfilters cqtfilters gabfilters</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   References:</span><span class="w"></span>
<span class="c">%     N. Holighaus, G. Koliander, and Z. Průša. On the derivatives of the</span><span class="w"></span>
<span class="c">%     continuous wavelet transform - with application to phaseless</span><span class="w"></span>
<span class="c">%     reconstruction. Submitted., 2018.</span><span class="w"></span>
<span class="c">%     </span><span class="w"></span>
<span class="c">%     Z. Průša and N. Holighaus. Non-iterative filter bank phase</span><span class="w"></span>
<span class="c">%     (re)construction. In Proc. 25th European Signal Processing Conference</span><span class="w"></span>
<span class="c">%     (EUSIPCO--2017), pages 952--956, Aug 2017.</span><span class="w"></span>
<span class="c">%     </span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">%   Url: http://ltfat.github.io/doc/filterbank/filterbankconstphase.html</span><span class="w"></span>

<span class="c">% Copyright (C) 2005-2023 Peter L. Soendergaard &lt;peter@sonderport.dk&gt; and others.</span><span class="w"></span>
<span class="c">% This file is part of LTFAT version 2.6.0</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">% This program is free software: you can redistribute it and/or modify</span><span class="w"></span>
<span class="c">% it under the terms of the GNU General Public License as published by</span><span class="w"></span>
<span class="c">% the Free Software Foundation, either version 3 of the License, or</span><span class="w"></span>
<span class="c">% (at your option) any later version.</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">% This program is distributed in the hope that it will be useful,</span><span class="w"></span>
<span class="c">% but WITHOUT ANY WARRANTY; without even the implied warranty of</span><span class="w"></span>
<span class="c">% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><span class="w"></span>
<span class="c">% GNU General Public License for more details.</span><span class="w"></span>
<span class="c">%</span><span class="w"></span>
<span class="c">% You should have received a copy of the GNU General Public License</span><span class="w"></span>
<span class="c">% along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span><span class="w"></span>

<span class="c">% AUTHOR: Nicki Holighaus, Zdenek Prusa</span><span class="w"></span>

<span class="n">thismfilename</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">upper</span><span class="p">(</span><span class="nb">mfilename</span><span class="p">);</span><span class="w"></span>
<span class="n">complainif_notenoughargs</span><span class="p">(</span><span class="nb">nargin</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">thismfilename</span><span class="p">);</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="nb">isnumeric</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">iscell</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;%s: *s* must be numeric or cell.&#39;</span><span class="p">,</span><span class="n">thismfilename</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isnumeric</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;%s: a must be non-empty numeric.&#39;</span><span class="p">,</span><span class="nb">upper</span><span class="p">(</span><span class="nb">mfilename</span><span class="p">));</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="n">definput</span><span class="p">.</span><span class="n">keyvals</span><span class="p">.</span><span class="n">tol</span><span class="p">=[</span><span class="mf">1e-1</span><span class="p">,</span><span class="mf">1e-10</span><span class="p">];</span><span class="w"></span>
<span class="n">definput</span><span class="p">.</span><span class="n">keyvals</span><span class="p">.</span><span class="n">gderivweight</span><span class="p">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="n">definput</span><span class="p">.</span><span class="n">keyvals</span><span class="p">.</span><span class="n">mask</span><span class="p">=[];</span><span class="w"></span>
<span class="n">definput</span><span class="p">.</span><span class="n">keyvals</span><span class="p">.</span><span class="n">usephase</span><span class="p">=[];</span><span class="w"></span>
<span class="n">definput</span><span class="p">.</span><span class="n">keyvals</span><span class="p">.</span><span class="n">custscaling</span><span class="p">=[];</span><span class="w"></span>
<span class="n">definput</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">real</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;real&#39;</span><span class="p">,</span><span class="s">&#39;complex&#39;</span><span class="p">};</span><span class="w"></span>
<span class="n">definput</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">scaling</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;naturalscaling&#39;</span><span class="p">,</span><span class="s">&#39;peakscaling&#39;</span><span class="p">,</span><span class="s">&#39;custscaling&#39;</span><span class="p">};</span><span class="w"></span>
<span class="n">definput</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">phasemagrel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#39;gabor&#39;</span><span class="p">,</span><span class="s">&#39;wavelet&#39;</span><span class="p">};</span><span class="w"></span>
<span class="p">[</span><span class="n">flags</span><span class="p">,</span><span class="n">kv</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">usephase</span><span class="p">]=</span><span class="n">ltfatarghelper</span><span class="p">({</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="s">&#39;usephase&#39;</span><span class="p">},</span><span class="n">definput</span><span class="p">,</span><span class="nb">varargin</span><span class="p">);</span><span class="w"></span>
<span class="n">tol</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kv</span><span class="p">.</span><span class="n">tol</span><span class="p">;</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isnumeric</span><span class="p">(</span><span class="n">tol</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">~</span><span class="nb">isequal</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span><span class="nb">sort</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span><span class="s">&#39;descend&#39;</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nb">error</span><span class="p">([</span><span class="s">&#39;%s: *tol* must be a scalar or a vector sorted in a &#39;</span><span class="p">,</span><span class="k">...</span><span class="w"></span>
<span class="w">          </span><span class="s">&#39;descending manner.&#39;</span><span class="p">],</span><span class="n">thismfilename</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">usephase</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;%s: Both mask and usephase must be used at the same time.&#39;</span><span class="p">,</span><span class="k">...</span><span class="w"></span>
<span class="w">          </span><span class="nb">upper</span><span class="p">(</span><span class="nb">mfilename</span><span class="p">));</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">usephase</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">complainif_notequalsize</span><span class="p">(</span><span class="s">&#39;usephase&#39;</span><span class="p">,</span><span class="n">usephase</span><span class="p">,</span><span class="s">&#39;s&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="nb">mfilename</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">complainif_notreal</span><span class="p">(</span><span class="s">&#39;usephase&#39;</span><span class="p">,</span><span class="n">usephase</span><span class="p">,</span><span class="nb">mfilename</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">complainif_notequalsize</span><span class="p">(</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="s">&#39;s&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="nb">mfilename</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">complainif_notreal</span><span class="p">(</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="nb">mfilename</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="nb">iscell</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">M</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">sEl</span><span class="p">)</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">sEl</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">W</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">s</span><span class="p">{</span><span class="mi">1</span><span class="p">},</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">W</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="n">do_uniform</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">wasCell</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="n">tgrad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span><span class="w"> </span><span class="n">fgrad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[];</span><span class="w"></span>

<span class="n">asan</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">comp_filterbank_a</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">M</span><span class="p">);</span><span class="w"></span>
<span class="n">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">asan</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">./</span><span class="n">asan</span><span class="p">(:,</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="n">L</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">N</span><span class="o">.*</span><span class="n">a</span><span class="p">;</span><span class="w"></span>

<span class="c">%TODO: Check all L?</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nb">isa</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="s">&#39;function_handle&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">fc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">fc</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="k">end</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nb">isa</span><span class="p">(</span><span class="n">tfr</span><span class="p">,</span><span class="s">&#39;function_handle&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">tfr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">tfr</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="k">end</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="nb">isscalar</span><span class="p">(</span><span class="n">tfr</span><span class="p">),</span><span class="w"> </span><span class="n">tfr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">repmat</span><span class="p">(</span><span class="n">tfr</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isnumeric</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="n">M</span><span class="w"></span>
<span class="w">  </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;%s: fc must be non-empty numeric.&#39;</span><span class="p">,</span><span class="nb">upper</span><span class="p">(</span><span class="nb">mfilename</span><span class="p">));</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w">  </span><span class="o">~</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nb">isvector</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">       </span><span class="p">(</span><span class="nb">iscell</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">       </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">all</span><span class="p">(</span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">tEl</span><span class="p">)</span><span class="w"> </span><span class="nb">isequal</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">tEl</span><span class="p">),</span><span class="nb">size</span><span class="p">(</span><span class="n">s</span><span class="p">)),</span><span class="n">tfr</span><span class="p">))))</span><span class="w"></span>
<span class="w">    </span><span class="nb">error</span><span class="p">([</span><span class="s">&#39;%s: tfr must be either a vector of length %d or a &#39;</span><span class="p">,</span><span class="k">...</span><span class="w"></span>
<span class="w">           </span><span class="s">&#39;2 element cell array containing phase derivatives such that &#39;</span><span class="p">,</span><span class="k">...</span><span class="w"></span>
<span class="w">           </span><span class="s">&#39;{tgrad,fgrad}.&#39;</span><span class="p">],</span><span class="nb">upper</span><span class="p">(</span><span class="nb">mfilename</span><span class="p">),</span><span class="n">M</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="n">do_naturalscaling</span><span class="w"></span>
<span class="w">    </span><span class="n">scal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="o">./</span><span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">asan</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">./</span><span class="n">asan</span><span class="p">(:,</span><span class="mi">2</span><span class="p">)));</span><span class="w"></span>
<span class="k">elseif</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="n">do_peakscaling</span><span class="w"></span>
<span class="w">    </span><span class="n">scal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="k">elseif</span><span class="w"> </span><span class="n">flags</span><span class="p">.</span><span class="n">do_custscaling</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">kv</span><span class="p">.</span><span class="n">custscaling</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">~</span><span class="nb">isvector</span><span class="p">(</span><span class="n">kv</span><span class="p">.</span><span class="n">custscaling</span><span class="p">)</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">       </span><span class="o">||</span><span class="w"> </span><span class="o">~</span><span class="nb">isnumeric</span><span class="p">(</span><span class="n">kv</span><span class="p">.</span><span class="n">custscaling</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">numel</span><span class="p">(</span><span class="n">kv</span><span class="p">.</span><span class="n">custscaling</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="n">M</span><span class="w"></span>
<span class="w">        </span><span class="nb">error</span><span class="p">([</span><span class="s">&#39;%s: value for key custscaling must be a numeic vector&#39;</span><span class="p">,</span><span class="k">...</span><span class="w"></span>
<span class="w">               </span><span class="s">&#39; of length %d.&#39;</span><span class="p">],</span><span class="n">thismfilename</span><span class="p">,</span><span class="n">M</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">    </span><span class="n">scal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">kv</span><span class="p">.</span><span class="n">custscaling</span><span class="p">(:);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="nb">iscell</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">iscell</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">complainif_notequalsize</span><span class="p">(</span><span class="s">&#39;tgrad&#39;</span><span class="p">,</span><span class="n">tfr</span><span class="p">{</span><span class="mi">1</span><span class="p">},</span><span class="s">&#39;s&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="nb">mfilename</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">complainif_notreal</span><span class="p">(</span><span class="s">&#39;tgrad&#39;</span><span class="p">,</span><span class="n">tfr</span><span class="p">{</span><span class="mi">1</span><span class="p">},</span><span class="nb">mfilename</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">complainif_notequalsize</span><span class="p">(</span><span class="s">&#39;fgrad&#39;</span><span class="p">,</span><span class="n">tfr</span><span class="p">{</span><span class="mi">2</span><span class="p">},</span><span class="s">&#39;s&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="nb">mfilename</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">complainif_notreal</span><span class="p">(</span><span class="s">&#39;fgrad&#39;</span><span class="p">,</span><span class="n">tfr</span><span class="p">{</span><span class="mi">2</span><span class="p">},</span><span class="nb">mfilename</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>

<span class="w">    </span><span class="n">wasCell</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="n">N</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">do_uniform</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">abss</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="nb">cell2mat</span><span class="p">(</span><span class="nb">cellfun</span><span class="p">(@</span><span class="n">times</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="nb">num2cell</span><span class="p">(</span><span class="n">scal</span><span class="p">),</span><span class="s">&#39;UniformOutput&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)));</span><span class="w"></span>
<span class="w">        </span><span class="n">swork</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell2mat</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span><span class="w">         </span><span class="n">mask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell2mat</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span><span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">usephase</span><span class="p">),</span><span class="w"> </span><span class="n">usephase</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell2mat</span><span class="p">(</span><span class="n">usephase</span><span class="p">);</span><span class="w"> </span><span class="k">end</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">iscell</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">tgrad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell2mat</span><span class="p">(</span><span class="n">tfr</span><span class="p">{</span><span class="mi">1</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="n">fgrad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cell2mat</span><span class="p">(</span><span class="n">tfr</span><span class="p">{</span><span class="mi">2</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="k">end</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">swork</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">M</span><span class="p">,</span><span class="n">W</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="p">=</span><span class="mi">1</span><span class="p">:</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">swork</span><span class="p">(:,</span><span class="n">m</span><span class="p">,:)=</span><span class="n">s</span><span class="p">{</span><span class="n">m</span><span class="p">};</span><span class="w"> </span><span class="k">end</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">iscell</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">tgrad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">M</span><span class="p">,</span><span class="n">W</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">fgrad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">M</span><span class="p">,</span><span class="n">W</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="p">=</span><span class="mi">1</span><span class="p">:</span><span class="n">M</span><span class="w"></span>
<span class="w">                </span><span class="n">tgrad</span><span class="p">(:,</span><span class="n">m</span><span class="p">,:)=</span><span class="n">tfr</span><span class="p">{</span><span class="mi">1</span><span class="p">}{</span><span class="n">m</span><span class="p">};</span><span class="w"> </span>
<span class="w">                </span><span class="n">fgrad</span><span class="p">(:,</span><span class="n">m</span><span class="p">,:)=</span><span class="n">tfr</span><span class="p">{</span><span class="mi">2</span><span class="p">}{</span><span class="n">m</span><span class="p">};</span><span class="w"> </span>
<span class="w">            </span><span class="k">end</span><span class="w"></span>
<span class="w">        </span><span class="k">end</span><span class="w"></span>

<span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="n">swork</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="n">do_uniform</span><span class="w"></span>
<span class="w">    </span><span class="n">abss</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="nb">bsxfun</span><span class="p">(@</span><span class="n">times</span><span class="p">,</span><span class="n">swork</span><span class="p">,</span><span class="n">scal</span><span class="p">(:).</span><span class="o">&#39;</span><span class="p">));</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">usephase</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">usephase</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">angle</span><span class="p">(</span><span class="n">swork</span><span class="p">);</span><span class="w"></span>
<span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isreal</span><span class="p">(</span><span class="n">usephase</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;%s: usephase must be real.&#39;</span><span class="p">,</span><span class="n">thismfilename</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isreal</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;%s: mask must be real.&#39;</span><span class="p">,</span><span class="n">thismfilename</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">    </span><span class="n">mask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cast</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="s">&#39;double&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="o">~=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">tgrad</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">fgrad</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">tfr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">tfr</span><span class="p">);</span><span class="c">% sqrt(1./( (tfr./1.875657).^2*L(1) ));</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="n">do_uniform</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">tgrad</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">fgrad</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="n">tgrad</span><span class="p">,</span><span class="n">fgrad</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">            </span><span class="n">comp_ufilterbankphasegradfrommag</span><span class="p">(</span><span class="k">...</span><span class="w"></span>
<span class="w">            </span><span class="n">abss</span><span class="p">,</span><span class="n">N</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">a</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">tfr</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="n">flags</span><span class="p">.</span><span class="n">do_real</span><span class="p">,</span><span class="n">flags</span><span class="p">.</span><span class="n">do_gabor</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>

<span class="w">    </span><span class="p">[</span><span class="n">newphase</span><span class="p">,</span><span class="n">usedmask</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">        </span><span class="n">comp_ufilterbankconstphase</span><span class="p">(</span><span class="k">...</span><span class="w"></span>
<span class="w">        </span><span class="n">abss</span><span class="p">,</span><span class="n">tgrad</span><span class="p">,</span><span class="n">fgrad</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">usephase</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">flags</span><span class="p">.</span><span class="n">do_real</span><span class="p">);</span><span class="w"></span>
<span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="n">NEIGH</span><span class="p">,</span><span class="w"> </span><span class="n">posInfo</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">comp_filterbankneighbors</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">flags</span><span class="p">.</span><span class="n">do_real</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">NEIGH</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">NEIGH</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">tgrad</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">isempty</span><span class="p">(</span><span class="n">fgrad</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="n">tgrad</span><span class="p">,</span><span class="n">fgrad</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">            </span><span class="n">comp_filterbankphasegradfrommag</span><span class="p">(</span><span class="k">...</span><span class="w"></span>
<span class="w">            </span><span class="n">abss</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">tfr</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="n">NEIGH</span><span class="p">,</span><span class="n">posInfo</span><span class="p">,</span><span class="n">kv</span><span class="p">.</span><span class="n">gderivweight</span><span class="p">,</span><span class="n">flags</span><span class="p">.</span><span class="n">do_gabor</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>

<span class="w">    </span><span class="p">[</span><span class="n">newphase</span><span class="p">,</span><span class="n">usedmask</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">...</span><span class="w"></span>
<span class="w">        </span><span class="n">comp_filterbankconstphase</span><span class="p">(</span><span class="k">...</span><span class="w"></span>
<span class="w">        </span><span class="n">abss</span><span class="p">,</span><span class="n">tgrad</span><span class="p">,</span><span class="n">fgrad</span><span class="p">,</span><span class="n">NEIGH</span><span class="p">,</span><span class="n">posInfo</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">usephase</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="n">c</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">swork</span><span class="p">)</span><span class="o">.*</span><span class="nb">exp</span><span class="p">(</span>1<span class="nb">i</span><span class="o">*</span><span class="n">newphase</span><span class="p">);</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="n">wasCell</span><span class="w"></span>
<span class="w">    </span><span class="c">% Apply the phase and convert back to cell array </span><span class="w"></span>
<span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mat2cell</span><span class="p">(</span><span class="n">c</span><span class="p">(:),</span><span class="n">N</span><span class="p">,</span><span class="n">W</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">newphase</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mat2cell</span><span class="p">(</span><span class="n">newphase</span><span class="p">(:),</span><span class="n">N</span><span class="p">,</span><span class="n">W</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">usedmask</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mat2cell</span><span class="p">(</span><span class="n">usedmask</span><span class="p">(:),</span><span class="n">N</span><span class="p">,</span><span class="n">W</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">tgrad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mat2cell</span><span class="p">(</span><span class="n">tgrad</span><span class="p">(:),</span><span class="n">N</span><span class="p">,</span><span class="n">W</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">fgrad</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">mat2cell</span><span class="p">(</span><span class="n">fgrad</span><span class="p">(:),</span><span class="n">N</span><span class="p">,</span><span class="n">W</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>


<span class="k">function</span><span class="w"> </span><span class="nf">complainif_notequalsize</span><span class="p">(</span>aname,a,bname,b,thismfilename<span class="p">)</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isequal</span><span class="p">(</span><span class="nb">class</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="nb">class</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;%s: %s and %s must be of the same type.&#39;</span><span class="p">,</span><span class="k">...</span><span class="w"></span>
<span class="w">          </span><span class="n">aname</span><span class="p">,</span><span class="w"> </span><span class="n">bname</span><span class="p">,</span><span class="w"> </span><span class="n">thismfilename</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">isequal</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;%s: %s and %s must have equal sizes.&#39;</span><span class="p">,</span><span class="k">...</span><span class="w"></span>
<span class="w">          </span><span class="n">aname</span><span class="p">,</span><span class="w"> </span><span class="n">bname</span><span class="p">,</span><span class="n">thismfilename</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="nb">iscell</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="nb">all</span><span class="p">(</span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">aEl</span><span class="p">,</span><span class="n">bEl</span><span class="p">)</span><span class="w"> </span><span class="nb">isequal</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">aEl</span><span class="p">),</span><span class="nb">size</span><span class="p">(</span><span class="n">bEl</span><span class="p">)),</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;%s: %s and %s must have equal sizes.&#39;</span><span class="p">,</span><span class="k">...</span><span class="w"></span>
<span class="w">              </span><span class="n">aname</span><span class="p">,</span><span class="w"> </span><span class="n">bname</span><span class="p">,</span><span class="n">thismfilename</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">function</span><span class="w"> </span><span class="nf">complainif_notreal</span><span class="p">(</span>aname,a,thismfilename<span class="p">)</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="nb">iscell</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">isareal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">all</span><span class="p">(</span><span class="nb">cellfun</span><span class="p">(@</span><span class="nb">isreal</span><span class="p">,</span><span class="n">a</span><span class="p">));</span><span class="w"></span>
<span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="n">isareal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">isreal</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="o">~</span><span class="n">isareal</span><span class="w"></span>
<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;%s: %s must be real.&#39;</span><span class="p">,</span><span class="n">thismfilename</span><span class="p">,</span><span class="n">aname</span><span class="p">);</span><span class="w"></span>
<span class="k">end</span><span class="w"></span>
</pre></div>


        <div class="include" file="../../include/footer.html"></div>
    </div>
</div>
<!-- These two have to be here to dynamically load the included parts -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script
src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.6.5/js/bootstrap-select.min.js"></script>
<script src="../../js/ltfat.js" type="text/javascript"></script>
<script src="../include/lookup.js" type="text/javascript"></script>
<script src="../include/jumplist.js" type="text/javascript"></script>
</body>
</html>

